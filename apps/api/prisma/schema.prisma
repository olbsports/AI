generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== ORGANIZATIONS ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String?  @unique
  logoUrl   String?

  // Subscription
  plan           String   @default("starter") // starter, professional, enterprise
  subscriptionId String?
  stripeCustomerId String?
  tokenBalance   Int      @default(0)

  // Settings
  settings  Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users               User[]
  horses              Horse[]
  riders              Rider[]
  analysisSessions    AnalysisSession[]
  reports             Report[]
  teamInvitations     TeamInvitation[]
  tokenTransactions   TokenTransaction[]
  tokenReservations   TokenReservation[]
  invoices            Invoice[]
  auditLogs           AuditLog[]
  marketplaceListings MarketplaceListing[]
  favorites           Favorite[]
  socialPosts         SocialPost[]
  notifications       Notification[]
  clubs               ClubMembership[]
  calendarEvents      CalendarEvent[]
  healthReminders     HealthReminder[]

  @@map("organizations")
}

// ==================== USERS ====================

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String
  firstName      String
  lastName       String
  phone          String?
  avatarUrl      String?
  role           String   @default("viewer") // owner, admin, veterinarian, analyst, viewer
  isActive       Boolean  @default(true)
  emailVerified  Boolean  @default(false)

  // 2FA
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Gamification
  xp              Int      @default(0)
  level           Int      @default(1)
  badges          Json     @default("[]")

  // Social
  bio             String?
  isPublic        Boolean  @default(true)
  followersCount  Int      @default(0)
  followingCount  Int      @default(0)

  // Preferences
  preferences    Json?
  locale         String   @default("fr")

  // Push notifications
  fcmToken       String?
  apnsToken      String?

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  lastLoginAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  createdAnalyses         AnalysisSession[]
  reviewedReports         Report[]              @relation("ReviewedBy")
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  marketplaceListings     MarketplaceListing[]
  favorites               Favorite[]
  socialPosts             SocialPost[]
  comments                Comment[]
  likes                   Like[]
  commentLikes            CommentLike[]
  savedPosts              SavedPost[]
  sentMessages            Message[]             @relation("SentMessages")
  receivedMessages        Message[]             @relation("ReceivedMessages")
  notifications           Notification[]
  followers               Follow[]              @relation("Following")
  following               Follow[]              @relation("Followers")
  achievements            Achievement[]
  clubMemberships         ClubMembership[]

  // Blocks and Reports
  blockedUsers            UserBlock[]           @relation("Blocker")
  blockedByUsers          UserBlock[]           @relation("Blocked")
  reportsMade             UserReport[]          @relation("Reporter")
  reportsReceived         UserReport[]          @relation("ReportedUser")

  // Horses ownership
  ownedHorses             Horse[]               @relation("HorseOwner")

  // Support
  supportTickets          SupportTicket[]       @relation("UserTickets")
  assignedTickets         SupportTicket[]       @relation("AssignedTickets")
  ticketMessages          TicketMessage[]

  // Subscriptions
  subscriptions           Subscription[]

  // Audit logs
  auditLogs               AuditLog[]            @relation("AuditActor")

  // Push Notifications
  pushSubscriptions       PushSubscription[]
  notificationPreferences NotificationPreference?

  // Marketplace alerts
  listingAlerts           ListingAlert[]

  // Sessions (Device Tracking)
  sessions                UserSession[]

  // Stories
  stories                 Story[]               @relation("UserStories")
  storyViews              StoryView[]           @relation("StoryViews")

  // Calendar & Reminders
  calendarEvents          CalendarEvent[]
  eventReminders          EventReminder[]

  // Gamification
  userChallenges          UserChallenge[]
  userStreak              UserStreak?
  referralsMade           Referral[]            @relation("Referrer")
  referredBy              Referral[]            @relation("Referee")
  xpTransactions          XpTransaction[]

  @@map("users")
}

// ==================== HORSES ====================

model Horse {
  id             String   @id @default(uuid())
  name           String
  sireId         String?  // Numéro SIRE
  ueln           String?  // Universal Equine Life Number
  microchip      String?

  gender         String   // male, female, gelding
  birthDate      DateTime?
  breed          String?
  studbook       String?  // SF, KWPN, BWP, etc.
  color          String?
  heightCm       Int?
  weightKg       Int?

  // Pedigree / Origines
  sireName       String?  // Père
  sireUeln       String?
  damName        String?  // Mère
  damUeln        String?
  // Grands-parents paternels
  siresSireName  String?  // Grand-père paternel
  siresDamName   String?  // Grand-mère paternelle
  // Grands-parents maternels
  damsSireName   String?  // Grand-père maternel
  damsDamName    String?  // Grand-mère maternelle
  // Pedigree complet JSON (4 générations)
  pedigree       Json?    // { sire: {...}, dam: {...}, sireSire: {...}, sireDam: {...}, damSire: {...}, damDam: {...}, ... }

  // Owner info
  ownerName      String?
  ownerEmail     String?
  ownerPhone     String?
  photoUrl       String?
  galleryUrls    Json     @default("[]")

  // Disciplines & level
  disciplines    Json     @default("[]") // ["CSO", "Dressage", "CCE"]
  level          String?  // Loisir, Club, Amateur, Pro
  ffeNumber      String?  // Numéro licence FFE

  // Health & vet
  healthStatus   String   @default("healthy") // healthy, injured, recovering, retired
  lastVetCheck   DateTime?
  vetNotes       String?
  vaccinations   Json     @default("[]")

  // Location
  stableName     String?
  stableAddress  String?
  latitude       Float?
  longitude      Float?

  status         String   @default("active") // active, retired, sold, deceased, for_sale
  tags           Json     @default("[]")
  notes          String?

  // Sync status for external data
  lastSyncAt     DateTime?
  syncStatus     String   @default("pending") // pending, synced, error

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Owner (User)
  ownerId        String?
  owner          User?    @relation("HorseOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Rider
  riderId        String?
  rider          Rider?   @relation(fields: [riderId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  analysisSessions    AnalysisSession[]
  reports             Report[]
  equiCoteValuations  EquiCoteValuation[]
  equiTraceHistory    EquiTraceEntry[]
  competitionResults  CompetitionResult[]
  healthRecords       HealthRecord[]
  gestations          Gestation[]
  breedingRecords     BreedingRecord[]
  marketplaceListings MarketplaceListing[]
  externalDataCache   ExternalDataCache[]
  socialPosts         SocialPost[]
  radiologyAnalyses   RadiologyAnalysis[]
  performances        HorsePerformance[]
  bodyConditionScores BodyConditionScore[]
  calendarEvents      CalendarEvent[]
  healthReminders     HealthReminder[]    @relation("HorseHealthReminders")

  @@index([sireId])
  @@index([ueln])
  @@index([microchip])
  @@index([ffeNumber])
  @@map("horses")
}

// ==================== EQUICOTE - HORSE VALUATION ====================

model EquiCoteValuation {
  id              String   @id @default(uuid())

  // Estimation
  minPrice        Int
  maxPrice        Int
  averagePrice    Int
  confidence      Float    // 0-100

  // Factors breakdown
  factors         Json     // { age, level, competition, health, lineage, market }

  // Market data
  comparableCount Int      @default(0)
  marketTrend     String?  // up, down, stable
  demandIndex     Float?   // 0-100

  // AI analysis
  aiAnalysis      String?
  aiRecommendations Json   @default("[]")

  // Sources
  dataSources     Json     @default("[]") // ["FFE", "SireWeb", "Marketplace"]

  // Validity
  validUntil      DateTime
  isExpired       Boolean  @default(false)

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  // Request info
  requestedById   String?
  tokensConsumed  Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId, createdAt])
  @@map("equicote_valuations")
}

// ==================== EQUITRACE - HORSE HISTORY ====================

model EquiTraceEntry {
  id              String   @id @default(uuid())

  // Entry type
  type            String   // ownership, competition, health, location, training, sale

  // Details
  date            DateTime
  title           String
  description     String?

  // Source
  source          String   // manual, FFE, SireWeb, IFCE, scraping
  sourceId        String?
  sourceUrl       String?
  verified        Boolean  @default(false)

  // Metadata
  metadata        Json?

  // Attachments
  attachments     Json     @default("[]")

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId, date])
  @@index([type])
  @@map("equitrace_entries")
}

// ==================== COMPETITION RESULTS ====================

model CompetitionResult {
  id              String   @id @default(uuid())

  // Competition info
  competitionName String
  competitionDate DateTime
  location        String?
  country         String   @default("FRA")

  // Event details
  discipline      String   // CSO, Dressage, CCE, Endurance
  eventName       String?
  eventLevel      String?  // Club, Amateur, Pro

  // Result
  rank            Int?
  totalParticipants Int?
  score           Float?
  penalties       Float?
  time            Float?   // seconds

  // Prize money
  prizeMoney      Float?
  currency        String   @default("EUR")

  // Rider info
  riderName       String?
  riderFfeNumber  String?

  // Source
  source          String   // FFE, manual, scraping
  sourceId        String?
  sourceUrl       String?

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId, competitionDate])
  @@index([discipline])
  @@map("competition_results")
}

// ==================== HEALTH RECORDS ====================

model HealthRecord {
  id              String   @id @default(uuid())

  // Record type
  type            String   // vaccination, deworming, vet_visit, injury, surgery, dental, shoeing

  // Details
  date            DateTime
  title           String
  description     String?

  // Veterinarian
  vetName         String?
  vetClinic       String?

  // Medication/treatment
  medication      String?
  dosage          String?
  duration        String?

  // Cost
  cost            Float?
  currency        String   @default("EUR")

  // Attachments
  attachments     Json     @default("[]")

  // Reminders
  nextDueDate     DateTime?
  reminderSent    Boolean  @default(false)

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  healthReminders HealthReminder[]

  @@index([horseId, date])
  @@index([type])
  @@map("health_records")
}

// ==================== GESTATION TRACKING ====================

model Gestation {
  id              String   @id @default(uuid())

  // Breeding info
  breedingDate    DateTime
  stallionName    String
  stallionUeln    String?
  stallionStudbook String?

  // Method
  method          String   // natural, fresh_ai, frozen_ai, embryo_transfer

  // Status
  status          String   @default("pending") // pending, confirmed, in_progress, born, lost

  // Dates
  confirmationDate DateTime?
  estimatedDueDate DateTime?
  actualBirthDate DateTime?

  // Vet checks
  vetChecks       Json     @default("[]") // Array of check dates and results

  // Foal info (if born)
  foalGender      String?
  foalName        String?
  foalColor       String?
  foalMicrochip   String?

  // Notes
  notes           String?
  complications   String?

  // Mare
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId])
  @@index([status])
  @@map("gestations")
}

// ==================== BREEDING RECORDS ====================

model BreedingRecord {
  id              String   @id @default(uuid())

  // Type (stallion or mare)
  role            String   // stallion, mare

  // Partner info
  partnerName     String
  partnerUeln     String?
  partnerStudbook String?

  // Breeding details
  year            Int
  method          String   // natural, fresh_ai, frozen_ai, embryo_transfer

  // Outcome
  success         Boolean?
  foalBorn        Boolean  @default(false)
  foalName        String?
  foalGender      String?

  // Genetic indices
  geneticIndices  Json?    // { ISO, IDR, ICC }

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId, year])
  @@map("breeding_records")
}

// ==================== EXTERNAL DATA CACHE ====================

model ExternalDataCache {
  id              String   @id @default(uuid())

  // Source info
  source          String   // FFE, IFCE, SireWeb, Equidia, LCI
  sourceId        String   // External ID from the source

  // Data type
  dataType        String   // horse_profile, competition, pedigree, indices, valuation

  // Cached data
  data            Json
  rawData         Json?    // Original response for debugging

  // Cache management
  fetchedAt       DateTime @default(now())
  expiresAt       DateTime
  isStale         Boolean  @default(false)

  // Horse relation (optional)
  horseId         String?
  horse           Horse?   @relation(fields: [horseId], references: [id], onDelete: Cascade)

  // Query params used
  queryParams     Json?

  @@unique([source, sourceId, dataType])
  @@index([source, expiresAt])
  @@index([horseId])
  @@map("external_data_cache")
}

// ==================== SCRAPING JOBS ====================

model ScrapingJob {
  id              String   @id @default(uuid())

  // Job type
  type            String   // horse_profile, competitions, pedigree, market_prices

  // Target
  source          String   // FFE, equidia, leboncoin, equirodi, horsetelex
  targetUrl       String?
  targetQuery     Json?

  // Status
  status          String   @default("pending") // pending, running, completed, failed, cancelled

  // Progress
  progress        Int      @default(0) // 0-100
  itemsFound      Int      @default(0)
  itemsProcessed  Int      @default(0)

  // Results
  results         Json?
  errorMessage    String?

  // Timing
  scheduledAt     DateTime?
  startedAt       DateTime?
  completedAt     DateTime?

  // Recurrence
  isRecurring     Boolean  @default(false)
  cronExpression  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, scheduledAt])
  @@map("scraping_jobs")
}

// ==================== MARKETPLACE LISTINGS ====================

model MarketplaceListing {
  id              String   @id @default(uuid())

  // Type
  type            String   // sale, lease, stallion_service, mare_lease, equipment

  // Status
  status          String   @default("active") // draft, active, pending, sold, leased, expired, cancelled

  // Basic info
  title           String
  description     String

  // Pricing
  price           Int?
  priceType       String   @default("fixed") // fixed, negotiable, auction, contact
  currency        String   @default("EUR")

  // For stallion services
  servicePrice    Int?
  freshSemen      Boolean  @default(false)
  frozenSemen     Boolean  @default(false)
  naturalService  Boolean  @default(false)

  // Location
  location        String?
  country         String   @default("FRA")
  latitude        Float?
  longitude       Float?

  // Media
  photos          Json     @default("[]")
  videos          Json     @default("[]")
  documents       Json     @default("[]")

  // Features
  hasEquiCote     Boolean  @default(false)
  hasEquiTrace    Boolean  @default(false)
  hasVetCheck     Boolean  @default(false)
  hasVideo        Boolean  @default(false)

  // Promotion
  isFeatured      Boolean  @default(false)
  featuredUntil   DateTime?
  boostLevel      Int      @default(0)

  // Stats
  viewCount       Int      @default(0)
  favoriteCount   Int      @default(0)
  contactCount    Int      @default(0)

  // Expiry
  expiresAt       DateTime?

  // Sale info (if sold)
  soldAt          DateTime?
  soldPrice       Int?

  // Horse (if horse listing)
  horseId         String?
  horse           Horse?   @relation(fields: [horseId], references: [id], onDelete: SetNull)

  // Seller
  sellerId        String
  seller          User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Organization
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  favorites       Favorite[]
  messages        Message[]
  promotions      ListingPromotion[]

  @@index([status, type])
  @@index([horseId])
  @@index([sellerId])
  @@map("marketplace_listings")
}

// ==================== LISTING PROMOTIONS ====================

model ListingPromotion {
  id              String   @id @default(uuid())

  // Listing
  listingId       String
  listing         MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Promotion type
  type            String   // featured, boost, refresh

  // Cost
  tokenCost       Int

  // Timing
  startedAt       DateTime @default(now())
  expiresAt       DateTime?

  createdAt       DateTime @default(now())

  @@index([listingId, expiresAt])
  @@index([type])
  @@map("listing_promotions")
}

// ==================== LISTING ALERTS ====================

model ListingAlert {
  id              String   @id @default(uuid())

  // User
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Alert filters (JSON)
  filters         Json     // { type, minPrice, maxPrice, breed, location, etc. }

  // Notification preferences
  notifyEmail     Boolean  @default(true)
  notifyPush      Boolean  @default(true)

  // Status
  isActive        Boolean  @default(true)
  lastTriggeredAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, isActive])
  @@map("listing_alerts")
}

// ==================== FAVORITES ====================

model Favorite {
  id              String   @id @default(uuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  listingId       String
  listing         MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([userId, listingId])
  @@map("favorites")
}

// ==================== MESSAGES ====================

model Message {
  id              String   @id @default(uuid())

  content         String

  // Attachments
  attachments     Json     @default("[]")

  // Read status
  isRead          Boolean  @default(false)
  readAt          DateTime?

  // Related listing (optional)
  listingId       String?
  listing         MarketplaceListing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  // Sender
  senderId        String
  sender          User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  // Receiver
  receiverId      String
  receiver        User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([senderId, createdAt])
  @@index([receiverId, isRead])
  @@map("messages")
}

// ==================== SOCIAL POSTS ====================

model SocialPost {
  id              String   @id @default(uuid())

  // Content
  content         String
  type            String   @default("post") // post, achievement, competition, sale

  // Media
  mediaUrls       Json     @default("[]")
  mediaType       String?  // image, video, gallery

  // Visibility
  visibility      String   @default("public") // public, followers, private

  // Stats
  likeCount       Int      @default(0)
  commentCount    Int      @default(0)
  shareCount      Int      @default(0)

  // Related entities
  horseId         String?
  horse           Horse?   @relation(fields: [horseId], references: [id], onDelete: SetNull)

  // Author
  authorId        String
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Organization
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  comments        Comment[]
  likes           Like[]
  savedPosts      SavedPost[]
  reports         UserReport[]
  hashtags        PostHashtag[]

  @@index([authorId, createdAt])
  @@index([visibility])
  @@map("social_posts")
}

// ==================== COMMENTS ====================

model Comment {
  id              String   @id @default(uuid())

  content         String
  likeCount       Int      @default(0)

  // Parent (for replies)
  parentId        String?
  parent          Comment? @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("Replies")

  // Post
  postId          String
  post            SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Author
  authorId        String
  author          User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Relations
  likes           CommentLike[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([postId, createdAt])
  @@map("comments")
}

// ==================== LIKES ====================

model Like {
  id              String   @id @default(uuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId          String
  post            SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([userId, postId])
  @@map("likes")
}

// ==================== COMMENT LIKES ====================

model CommentLike {
  id              String   @id @default(uuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  commentId       String
  comment         Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([userId, commentId])
  @@map("comment_likes")
}

// ==================== SAVED POSTS ====================

model SavedPost {
  id              String   @id @default(uuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId          String
  post            SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([userId, postId])
  @@map("saved_posts")
}

// ==================== FOLLOWS ====================

model Follow {
  id              String   @id @default(uuid())

  followerId      String
  follower        User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)

  followingId     String
  following       User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([followerId, followingId])
  @@map("follows")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id              String   @id @default(uuid())

  // Type
  type            String   // like, comment, follow, message, achievement, reminder, system

  // Content
  title           String
  body            String

  // Data
  data            Json?
  actionUrl       String?

  // Status
  isRead          Boolean  @default(false)
  readAt          DateTime?

  // Push status
  pushSent        Boolean  @default(false)
  pushSentAt      DateTime?

  // User
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Organization
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// ==================== PUSH SUBSCRIPTIONS ====================

model PushSubscription {
  id              String   @id @default(uuid())

  // User
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device info
  platform        String   // ios, android, web
  token           String   // FCM/APNs token
  deviceId        String
  deviceName      String?
  appVersion      String?

  // Status
  isActive        Boolean  @default(true)
  lastUsedAt      DateTime @default(now())

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, deviceId])
  @@index([userId, isActive])
  @@index([token])
  @@map("push_subscriptions")
}

model NotificationPreference {
  id              String   @id @default(uuid())

  // User
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Global settings
  pushEnabled     Boolean  @default(true)
  emailEnabled    Boolean  @default(true)
  inAppEnabled    Boolean  @default(true)

  // Quiet hours
  quietHoursEnabled Boolean @default(false)
  quietHoursStart  String   @default("22:00") // HH:mm format
  quietHoursEnd    String   @default("07:00")
  timezone         String   @default("Europe/Paris")

  // Per-category settings (JSON for flexibility)
  // { analyses: { push: true, email: true }, social: { push: false } }
  categorySettings Json     @default("{}")

  // Digest settings
  digestEnabled   Boolean  @default(false)
  digestFrequency String   @default("daily") // daily, weekly, never
  digestTime      String   @default("09:00")

  // Social settings
  likesFromFollowersOnly Boolean @default(false)
  mentionsFromFollowersOnly Boolean @default(false)
  messagesFromFollowersOnly Boolean @default(false)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("notification_preferences")
}

// ==================== ACHIEVEMENTS ====================

model Achievement {
  id              String   @id @default(uuid())

  // Achievement type
  type            String   // first_analysis, competition_win, monthly_active, etc.

  // Details
  name            String
  description     String
  iconUrl         String?

  // XP reward
  xpReward        Int      @default(0)

  // Unlock date
  unlockedAt      DateTime @default(now())

  // User
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("achievements")
}

// ==================== CLUBS ====================

model Club {
  id              String   @id @default(uuid())

  name            String
  description     String?
  logoUrl         String?
  coverUrl        String?

  // Type
  type            String   @default("stable") // stable, club, association, team

  // Location
  location        String?
  country         String   @default("FRA")

  // Privacy
  isPublic        Boolean  @default(true)
  requiresApproval Boolean @default(false)

  // Stats
  memberCount     Int      @default(0)

  // Settings
  settings        Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  memberships     ClubMembership[]

  @@map("clubs")
}

model ClubMembership {
  id              String   @id @default(uuid())

  role            String   @default("member") // owner, admin, member
  status          String   @default("active") // pending, active, left, banned

  clubId          String
  club            Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  joinedAt        DateTime @default(now())

  @@unique([clubId, userId])
  @@map("club_memberships")
}

// ==================== RADIOLOGY ANALYSIS ====================

model RadiologyAnalysis {
  id                String   @id @default(uuid())

  // Subject
  horseId           String
  horse             Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)
  organizationId    String

  // Exam info
  examDate          DateTime @default(now())
  examType          String   @default("standard") // standard, complete, expert
  indication        String?  // Reason for exam
  clinicalHistory   String?

  // Status
  status            String   @default("pending") // pending, uploading, processing, completed, failed, cancelled

  // AI Analysis
  aiModel           String?
  aiConfidence      Float?
  processingTimeMs  Int?
  startedAt         DateTime?
  completedAt       DateTime?
  errorMessage      String?

  // Results
  globalScore       Float?   // 0-100 overall health score
  category          String?  // A, A-, B+, B, B-, C, D (purchase exam)
  findings          Json     @default("[]") // Array of findings
  recommendations   Json     @default("[]")
  conclusion        String?

  // Veterinarian validation
  validatedById     String?
  validatedAt       DateTime?
  vetNotes          String?
  vetSignature      String?

  // Billing
  tokensConsumed    Int      @default(0)
  createdById       String

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  images            RadioImage[]
  report            Report?

  @@index([horseId, createdAt])
  @@index([organizationId, status])
  @@map("radiology_analyses")
}

model RadioImage {
  id                String   @id @default(uuid())

  // Analysis reference
  analysisId        String
  analysis          RadiologyAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Image info
  filename          String
  originalFilename  String
  mimeType          String   // image/jpeg, image/png, application/dicom
  fileSize          Int      // bytes
  url               String
  thumbnailUrl      String?

  // Anatomical region
  region            String   // boulet_ad, boulet_ag, jarret, genou, dos, pied, etc.
  regionLabel       String   // Human readable: "Boulet Antérieur Droit"
  view              String?  // face, profil, oblique

  // DICOM metadata (if applicable)
  dicomData         Json?

  // AI Analysis results for this image
  aiAnalyzed        Boolean  @default(false)
  aiScore           Float?   // 0-100
  detections        Json     @default("[]") // Array of RadioDetection

  // Order for display
  sortOrder         Int      @default(0)

  // Upload status
  uploadStatus      String   @default("pending") // pending, uploaded, processed, error

  createdAt         DateTime @default(now())

  @@index([analysisId])
  @@map("radio_images")
}

// ==================== AI ANALYSIS CACHE ====================

model AIAnalysisCache {
  id              String   @id @default(uuid())

  // Input hash for deduplication
  inputHash       String   @unique

  // Analysis type
  type            String   // valuation, locomotion, video, breeding_match

  // AI provider
  provider        String   // anthropic, openai
  model           String   // claude-3-opus, gpt-4-vision

  // Results
  result          Json
  confidence      Float?

  // Tokens used
  inputTokens     Int      @default(0)
  outputTokens    Int      @default(0)

  // Cost
  costUsd         Float    @default(0)

  // Cache
  expiresAt       DateTime

  createdAt       DateTime @default(now())

  @@index([type, expiresAt])
  @@map("ai_analysis_cache")
}

// ==================== AI COST METRICS ====================

model AICostMetric {
  id        String   @id @default(uuid())

  // Task information
  task      String   // video_analysis, chat, breeding_match, etc.
  model     String   // claude-3-haiku, claude-sonnet-4, etc.

  // Cost tracking
  cost      Float    @default(0) // Actual cost in USD
  saved     Float    @default(0) // Savings vs always using Sonnet

  // Timestamps
  createdAt DateTime @default(now())

  @@index([task, createdAt])
  @@index([model, createdAt])
  @@map("ai_cost_metrics")
}

// ==================== PERFORMANCE TRACKING ====================

model PerformanceSnapshot {
  id             String   @id @default(uuid())

  // Subject (horse or rider)
  subjectType    String   // horse, rider, pair
  horseId        String?
  riderId        String?

  // Snapshot date
  snapshotDate   DateTime @default(now())
  periodType     String   // daily, weekly, monthly, competition

  // Discipline and level
  discipline     String   // CSO, Dressage, CCE, Hunter, Endurance
  level          String   // Club4, Club3, Club2, Club1, Amateur, Pro

  // Global scores (0-100)
  globalScore    Float?
  techniqueScore Float?
  physicalScore  Float?
  mentalScore    Float?
  harmonyScore   Float?  // For pair evaluations

  // Detailed metrics (JSON for flexibility)
  metrics        Json     // { "impulsion": 75, "equilibre": 80, ... }

  // AI Analysis summary
  aiAnalysis     Json?    // Detailed AI feedback
  strengths      Json     @default("[]") // ["good_rhythm", "clean_jumps"]
  weaknesses     Json     @default("[]") // ["needs_impulsion", "late_changes"]
  recommendations Json    @default("[]")

  // Source data references
  analysisSessionId String?
  competitionId     String?

  // Timestamps
  createdAt      DateTime @default(now())

  @@index([horseId, snapshotDate])
  @@index([riderId, snapshotDate])
  @@index([subjectType, discipline, snapshotDate])
  @@map("performance_snapshots")
}

model ProgressMetric {
  id             String   @id @default(uuid())

  // Subject
  subjectType    String   // horse, rider, pair
  horseId        String?
  riderId        String?

  // Metric info
  metricName     String   // impulsion, equilibre, position, regularity, etc.
  metricCategory String   // technique, physical, mental, competition

  // Value tracking
  value          Float
  previousValue  Float?
  targetValue    Float?
  unit           String?  // percent, score, seconds, cm, etc.

  // Context
  discipline     String?
  level          String?
  context        String?  // training, competition, exam

  // Trend
  trend          String?  // improving, stable, declining
  trendStrength  Float?   // -1 to 1

  // Date
  recordedAt     DateTime @default(now())

  @@index([horseId, metricName, recordedAt])
  @@index([riderId, metricName, recordedAt])
  @@index([metricCategory, recordedAt])
  @@map("progress_metrics")
}

model EvolutionGoal {
  id             String   @id @default(uuid())

  // Subject
  subjectType    String   // horse, rider, pair
  horseId        String?
  riderId        String?

  // Goal details
  title          String
  description    String?
  goalType       String   // performance, technique, competition, health

  // Target metrics
  targetMetric   String   // metric name to track
  startValue     Float
  targetValue    Float
  currentValue   Float?
  unit           String?

  // Timeline
  startDate      DateTime @default(now())
  targetDate     DateTime
  completedDate  DateTime?

  // Status
  status         String   @default("active") // active, achieved, failed, paused
  progress       Float    @default(0) // 0-100 percent

  // Milestones
  milestones     Json     @default("[]") // [{ date, value, note }]

  // AI recommendations
  aiPlan         Json?    // Training plan to achieve goal
  adjustments    Json     @default("[]") // Plan modifications history

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([horseId, status])
  @@index([riderId, status])
  @@index([targetDate])
  @@map("evolution_goals")
}

model ComparisonReport {
  id             String   @id @default(uuid())

  // Comparison type
  comparisonType String   // temporal, cross_subject, benchmark

  // Subjects being compared
  subjects       Json     // [{ type, id, name, period? }]

  // Parameters
  discipline     String?
  level          String?
  metrics        Json     @default("[]") // Metrics included in comparison
  periodStart    DateTime?
  periodEnd      DateTime?

  // Results
  results        Json     // Detailed comparison data
  rankings       Json?    // For cross-subject comparisons
  insights       Json     @default("[]") // AI-generated insights
  recommendations Json    @default("[]")

  // Visualization data
  chartData      Json?    // Pre-computed chart data

  // Metadata
  generatedBy    String?  // user_id
  createdAt      DateTime @default(now())

  @@index([comparisonType, createdAt])
  @@map("comparison_reports")
}

model TrainingSession {
  id             String   @id @default(uuid())

  // Participants
  horseId        String
  riderId        String?

  // Session info
  sessionDate    DateTime
  duration       Int      // minutes
  sessionType    String   // flatwork, jumping, dressage, hack, lunging
  discipline     String?

  // Conditions
  weather        Json?    // { temp, humidity, wind, conditions }
  surface        String?  // sand, grass, hard, mixed
  location       String?

  // Planned work
  plannedExercises Json   @default("[]")
  objectives     Json     @default("[]")

  // Actual work
  completedExercises Json @default("[]")
  notes          String?

  // Performance data
  metrics        Json?    // { avg_heart_rate, distance, etc. }
  scores         Json?    // Exercise scores

  // AI feedback
  aiFeedback     Json?
  improvementAreas Json   @default("[]")

  // Fatigue tracking
  horseFatigueBefore Int? // 1-10
  horseFatigueAfter  Int? // 1-10
  riderFatigueBefore Int?
  riderFatigueAfter  Int?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([horseId, sessionDate])
  @@index([riderId, sessionDate])
  @@index([sessionType, sessionDate])
  @@map("training_sessions")
}

// ==================== RIDERS ====================

model Rider {
  id             String   @id @default(uuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  photoUrl       String?

  federationId   String?
  federationName String?
  level          String?
  discipline     String?

  // Gamification
  xp             Int      @default(0)
  level_rank     Int      @default(1)

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  horses           Horse[]
  analysisSessions AnalysisSession[]
  calendarEvents   CalendarEvent[]

  @@map("riders")
}

// ==================== ANALYSIS SESSIONS ====================

model AnalysisSession {
  id             String   @id @default(uuid())

  // Type and status
  type           String   // video_performance, video_course, radiological, locomotion, equicote, equitrace
  status         String   @default("pending") // pending, processing, completed, failed, cancelled

  title          String
  competition    Json?    // { name, location, level, date }

  // Input
  inputMediaUrls Json     @default("[]")
  inputMetadata  Json?

  // Results
  scores          Json?    // { global, horse, rider, harmony, technique }
  obstacles       Json?    // Array of obstacle analyses
  issues          Json?    // Array of issues
  recommendations Json     @default("[]")

  // AI
  aiProvider      String?  // anthropic, openai
  aiModel         String?
  aiAnalysis      Json?
  confidenceScore Float?

  // Processing
  startedAt       DateTime?
  completedAt     DateTime?
  processingTimeMs Int?
  errorMessage    String?

  // Billing
  tokensConsumed  Int      @default(0)

  // Organization
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Horse
  horseId         String?
  horse           Horse?   @relation(fields: [horseId], references: [id], onDelete: SetNull)

  // Rider
  riderId         String?
  rider           Rider?   @relation(fields: [riderId], references: [id], onDelete: SetNull)

  // Created by
  createdById     String
  createdBy       User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  report          Report?

  @@map("analysis_sessions")
}

// ==================== REPORTS ====================

model Report {
  id               String   @id @default(uuid())
  reportNumber     String   @unique // HV-RADIO-348

  // Type and status
  type             String   // course_analysis, radiological, locomotion, purchase_exam, equicote, equitrace
  status           String   @default("draft") // draft, pending_review, completed, archived

  // Exam metadata
  examDate         DateTime
  examTime         String?
  veterinarians    Json     @default("[]")
  location         String?

  // Scores
  globalScore      Float?
  category         String?  // A, A-, B+, B, B-, C, D
  categoryDescription String?

  // Radiological content
  images           Json?    // Array of radiographic images
  attentionPoints  Json?    // Array of attention points
  pathologiesSearched Json? // Array of pathologies

  // Regions
  examinedRegions  Json     @default("[]")
  missingRegions   Json     @default("[]")

  // Recommendations
  recommendations  Json     @default("[]")
  suggestedFollowUp String?
  conclusion       String?
  clinicalCorrelation String?

  // Generated files
  htmlReportUrl    String?
  pdfReportUrl     String?

  // Signature
  reviewedById     String?
  reviewedBy       User?    @relation("ReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedAt       DateTime?
  digitalSignature String?

  // Sharing
  shareToken       String?  @unique
  shareExpiresAt   DateTime?

  // Organization
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Analysis Session
  analysisSessionId String  @unique
  analysisSession   AnalysisSession @relation(fields: [analysisSessionId], references: [id], onDelete: Cascade)

  // Horse
  horseId          String?
  horse            Horse?   @relation(fields: [horseId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("reports")
}

// ==================== AUTH TOKENS ====================

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("email_verification_tokens")
}

// ==================== USER SESSIONS (Device Tracking) ====================

model UserSession {
  id            String   @id @default(uuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device info
  deviceId      String
  deviceName    String?
  platform      String?  // ios, android, web, desktop

  // Request info
  ipAddress     String?
  userAgent     String?

  // Session management
  lastActiveAt  DateTime @default(now())
  expiresAt     DateTime
  isRevoked     Boolean  @default(false)
  revokedAt     DateTime?

  createdAt     DateTime @default(now())

  @@unique([userId, deviceId])
  @@index([userId, isRevoked])
  @@index([expiresAt])
  @@map("user_sessions")
}

// ==================== LOGIN ATTEMPTS (Rate Limiting) ====================

model LoginAttempt {
  id          String   @id @default(uuid())

  email       String
  ipAddress   String?
  userAgent   String?

  successful  Boolean  @default(false)
  failReason  String?  // invalid_credentials, account_locked, 2fa_failed, etc.

  createdAt   DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

// ==================== TEAM INVITATIONS ====================

model TeamInvitation {
  id        String   @id @default(uuid())
  email     String
  role      String   @default("viewer")
  token     String   @unique
  expiresAt DateTime
  status    String   @default("pending") // pending, accepted, expired, cancelled

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("team_invitations")
}

// ==================== BILLING ====================

model TokenTransaction {
  id             String   @id @default(uuid())

  amount         Int      // Positive for credit, negative for debit
  type           String   // credit, debit, transfer_in, transfer_out
  description    String
  metadata       Json?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@map("token_transactions")
}

model TokenReservation {
  id             String   @id @default(uuid())

  amount         Int
  analysisId     String
  expiresAt      DateTime

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())

  @@index([organizationId, expiresAt])
  @@map("token_reservations")
}

// ==================== TOKEN PACKS (PURCHASE) ====================

model TokenPack {
  id              String   @id @default(uuid())

  name            String   // "Starter", "Standard", "Pro", etc.
  description     String?

  // Tokens
  baseTokens      Int      // Base tokens in pack
  bonusPercent    Int      @default(0) // Bonus percentage
  totalTokens     Int      // Computed: baseTokens * (1 + bonusPercent/100)

  // Pricing
  price           Int      // Price in cents (e.g., 999 = 9.99€)
  currency        String   @default("EUR")
  stripePriceId   String?  // Stripe Price ID for checkout

  // Display
  isActive        Boolean  @default(true)
  isPopular       Boolean  @default(false) // "Best Value" badge
  sortOrder       Int      @default(0)

  // Limits
  minQuantity     Int      @default(1)
  maxQuantity     Int      @default(10)
  limitPerMonth   Int?     // Max purchases per org per month

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchases       TokenPurchase[]

  @@map("token_packs")
}

model TokenPurchase {
  id                    String   @id @default(uuid())

  // Pack purchased
  packId                String
  pack                  TokenPack @relation(fields: [packId], references: [id])
  quantity              Int      @default(1)

  // Tokens delivered
  baseTokens            Int
  bonusTokens           Int
  totalTokens           Int

  // Payment
  amount                Int      // Amount paid in cents
  currency              String   @default("EUR")
  stripePaymentIntentId String?
  stripeSessionId       String?

  // Status
  status                String   @default("pending") // pending, completed, failed, refunded

  // Organization
  organizationId        String
  purchasedById         String   // User who made the purchase

  createdAt             DateTime @default(now())
  completedAt           DateTime?

  @@index([organizationId, createdAt])
  @@index([status])
  @@map("token_purchases")
}

model Invoice {
  id              String    @id @default(uuid())
  invoiceNumber   String    @unique
  stripeInvoiceId String?   @unique

  amount          Float
  currency        String    @default("EUR")
  status          String    @default("pending") // draft, pending, paid, failed, refunded
  description     String?

  paidAt          DateTime?
  dueDate         DateTime?

  invoiceUrl      String?
  pdfUrl          String?

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId, status])
  @@map("invoices")
}

// ==================== AUDIT LOGS ====================

model AuditLog {
  id             String   @id @default(uuid())

  action         String
  details        Json?

  // Resource being acted upon
  resourceType   String?
  resourceId     String?
  changes        Json?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Actor (who performed the action)
  actorId        String?
  actor          User?    @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([organizationId, action, createdAt])
  @@index([actorId, createdAt])
  @@map("audit_logs")
}

// ==================== API KEYS FOR EXTERNAL SERVICES ====================

model ApiKey {
  id              String   @id @default(uuid())

  name            String
  service         String   // fce, ifce, sireweb, stripe, anthropic, openai, resend

  // Encrypted key
  encryptedKey    String

  // Status
  isActive        Boolean  @default(true)
  lastUsedAt      DateTime?

  // Rate limiting
  dailyLimit      Int?
  dailyUsage      Int      @default(0)
  lastResetAt     DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([service])
  @@map("api_keys")
}


// ==================== STORIES (24h ephemeral content) ====================

model Story {
  id          String   @id @default(uuid())

  // Media
  mediaUrl    String
  mediaType   String   @default("image") // image, video

  // Content (optional caption)
  caption     String?

  // Stats
  viewsCount  Int      @default(0)

  // Expiration (24h from creation)
  expiresAt   DateTime

  // Author
  authorId    String
  author      User     @relation("UserStories", fields: [authorId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  // Relations
  views       StoryView[]

  @@index([authorId, expiresAt])
  @@index([expiresAt])
  @@map("stories")
}

model StoryView {
  id        String   @id @default(uuid())

  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  visitorId String
  visitor   User     @relation("StoryViews", fields: [visitorId], references: [id], onDelete: Cascade)

  viewedAt  DateTime @default(now())

  @@unique([storyId, visitorId])
  @@index([storyId])
  @@map("story_views")
}

// ==================== HASHTAGS ====================

model Hashtag {
  id          String   @id @default(uuid())

  name        String   @unique
  usageCount  Int      @default(0)
  lastUsedAt  DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts       PostHashtag[]

  @@index([usageCount])
  @@index([lastUsedAt])
  @@map("hashtags")
}

model PostHashtag {
  id        String   @id @default(uuid())

  postId    String
  post      SocialPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  hashtagId String
  hashtag   Hashtag  @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, hashtagId])
  @@index([hashtagId])
  @@map("post_hashtags")
}
// ==================== USER BLOCKS ====================

model UserBlock {
  id        String   @id @default(uuid())

  blockerId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)

  blockedId String
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
  @@map("user_blocks")
}

// ==================== USER REPORTS (Content Moderation) ====================

model UserReport {
  id              String   @id @default(uuid())

  reporterId      String
  reporter        User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  reportedUserId  String?
  reportedUser    User?    @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)

  reportedPostId  String?
  reportedPost    SocialPost? @relation(fields: [reportedPostId], references: [id], onDelete: Cascade)

  type            String   // user, post, comment
  reason          String
  details         String?
  status          String   @default("pending") // pending, reviewed, dismissed, action_taken

  reviewedById    String?
  reviewedAt      DateTime?
  reviewNotes     String?

  // Admin moderation fields
  moderatorId     String?
  moderatorNotes  String?
  actionTaken     String?
  resolvedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_reports")
}

// ==================== SUPPORT TICKETS ====================

model SupportTicket {
  id              String    @id @default(uuid())

  userId          String
  user            User      @relation("UserTickets", fields: [userId], references: [id], onDelete: Cascade)

  subject         String
  description     String    @db.Text
  category        String    @default("other") // billing, technical, account, feature, bug, other
  priority        String    @default("normal") // low, normal, high, urgent
  status          String    @default("open") // open, in_progress, waiting_for_user, resolved, closed

  assigneeId      String?
  assignee        User?     @relation("AssignedTickets", fields: [assigneeId], references: [id])

  messages        TicketMessage[]

  resolvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, status])
  @@map("support_tickets")
}

model TicketMessage {
  id          String   @id @default(uuid())

  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  content     String   @db.Text
  attachments Json?

  createdAt   DateTime @default(now())

  @@index([ticketId])
  @@map("ticket_messages")
}

// ==================== SYSTEM SETTINGS ====================

model SystemSettings {
  id                  String   @id @default(uuid())

  maintenanceMode     Boolean  @default(false)
  maintenanceMessage  String?

  registrationEnabled Boolean  @default(true)
  freeTrialEnabled    Boolean  @default(true)
  freeTrialDays       Int      @default(7)

  analysisPrice       Float    @default(0)
  maxAnalysesPerDay   Int      @default(100)

  allowedFileTypes    Json     @default("[\"jpg\",\"jpeg\",\"png\",\"mp4\",\"mov\"]")
  maxFileSize         Int      @default(100000000)

  featureFlags        Json     @default("{}")

  termsVersion        String?
  privacyVersion      String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("system_settings")
}

// ==================== GAMIFICATION: CHALLENGES ====================

model Challenge {
  id              String   @id @default(uuid())

  // Basic info
  title           String
  description     String

  // Type and configuration
  type            String   // daily, weekly, monthly
  conditionAction String   // login, analyze_horse, publish_post, complete_profile, add_horse, etc.
  conditionCount  Int      @default(1)

  // Rewards
  xpReward        Int      @default(0)
  tokenReward     Int      @default(0)

  // Availability
  startsAt        DateTime
  expiresAt       DateTime
  isActive        Boolean  @default(true)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userChallenges  UserChallenge[]

  @@index([type, isActive])
  @@index([startsAt, expiresAt])
  @@map("challenges")
}

model UserChallenge {
  id              String    @id @default(uuid())

  // Progress
  progress        Int       @default(0)
  completedAt     DateTime?
  claimedAt       DateTime?

  // User
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Challenge
  challengeId     String
  challenge       Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, challengeId])
  @@index([userId, completedAt])
  @@map("user_challenges")
}

// ==================== GAMIFICATION: STREAKS ====================

model UserStreak {
  id              String   @id @default(uuid())

  // Streak data
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActivityAt  DateTime?

  // Bonus tracking
  lastBonusAt     DateTime?
  totalBonusXp    Int      @default(0)

  // User
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_streaks")
}

// ==================== GAMIFICATION: REFERRALS ====================

model Referral {
  id              String    @id @default(uuid())

  // Unique referral code (HORSE-XXXXXX)
  code            String    @unique

  // Status
  status          String    @default("pending") // pending, completed

  // Rewards
  xpAwarded       Int       @default(0)
  tokensAwarded   Int       @default(0)

  // Referrer (who invited)
  referrerId      String
  referrer        User      @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  // Referee (who was invited)
  refereeId       String?
  referee         User?     @relation("Referee", fields: [refereeId], references: [id], onDelete: SetNull)

  // Invitation email (before signup)
  invitedEmail    String?

  // Timestamps
  createdAt       DateTime  @default(now())
  completedAt     DateTime?

  @@index([referrerId])
  @@index([code])
  @@map("referrals")
}

// ==================== GAMIFICATION: XP TRANSACTIONS ====================

model XpTransaction {
  id              String   @id @default(uuid())

  // Transaction details
  amount          Int
  source          String   // daily_login, challenge, referral, streak_bonus, achievement, analysis, post, etc.
  description     String

  // User
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@index([source])
  @@map("xp_transactions")
}

// ==================== SUBSCRIPTIONS ====================

model Subscription {
  id                    String    @id @default(uuid())

  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  planId                String
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])

  status                String    @default("active") // active, trialing, past_due, cancelled, expired, paused
  amount                Float?
  interval              String    @default("monthly") // monthly, quarterly, yearly

  startDate             DateTime  @default(now())
  endDate               DateTime?
  nextBillingDate       DateTime?

  cancelledAt           DateTime?
  cancellationReason    String?

  stripeSubscriptionId  String?
  stripeCustomerId      String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId, status])
  @@map("subscriptions")
}

model SubscriptionPlan {
  id                   String    @id @default(uuid())

  name                 String
  description          String?
  monthlyPrice         Float
  yearlyPrice          Float?
  features             Json      @default("[]")
  maxHorses            Int       @default(999)
  maxAnalysesPerMonth  Int       @default(999)

  isActive             Boolean   @default(true)

  subscriptions        Subscription[]

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@map("subscription_plans")
}

// ==================== HORSE PERFORMANCE TRACKING ====================

model HorsePerformance {
  id              String   @id @default(uuid())

  // Competition info
  date            DateTime
  competition     String   // Nom de la competition
  discipline      String   // CSO, Dressage, CCE, Hunter, Endurance
  level           String?  // Club4, Club3, Club2, Club1, Amateur, Pro

  // Results
  rank            Int?     // Classement
  totalParticipants Int?   // Nombre de participants
  penaltyPoints   Float?   // Points de penalite (fautes, refus)
  timeSeconds     Float?   // Temps en secondes
  score           Float?   // Score (pour dressage par ex.)
  percentage      Float?   // Pourcentage (dressage)

  // Context
  riderName       String?
  location        String?
  surfaceType     String?  // Sable, herbe, etc.
  weather         String?

  // Notes
  notes           String?

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId, date])
  @@index([discipline])
  @@map("horse_performances")
}

// ==================== BODY CONDITION SCORE ====================

model BodyConditionScore {
  id              String   @id @default(uuid())

  // Score (echelle 1-9 ou 1-5)
  score           Float    // Score global (1-9 echelle Henneke)
  scaleType       String   @default("henneke") // henneke (1-9), french (0-5)

  // Date de l'evaluation
  date            DateTime

  // Details par zone (optionnel)
  neckScore       Float?   // Encolure
  withersScore    Float?   // Garrot
  backScore       Float?   // Dos
  ribsScore       Float?   // Cotes
  tailheadScore   Float?   // Base de la queue
  shoulderScore   Float?   // Epaule

  // Mesures complementaires
  weightKg        Float?   // Poids estime
  bellyGirthCm    Float?   // Tour de sangle

  // Evaluateur
  evaluatedBy     String?  // Nom de l'evaluateur
  method          String   @default("visual") // visual, palpation, combined

  // Notes et recommandations
  notes           String?
  recommendations String?

  // Photos (optionnel)
  photoUrls       Json     @default("[]")

  // Horse
  horseId         String
  horse           Horse    @relation(fields: [horseId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([horseId, date])
  @@map("body_condition_scores")
}

// ==================== CALENDAR EVENTS ====================

model CalendarEvent {
  id              String   @id @default(uuid())

  // Basic info
  title           String
  description     String?
  type            String   // training, vet, competition, farrier, dental, vaccination, deworming, other

  // Timing
  startDate       DateTime
  endDate         DateTime?
  allDay          Boolean  @default(false)

  // Location
  location        String?
  latitude        Float?
  longitude       Float?

  // Status
  status          String   @default("scheduled") // scheduled, confirmed, cancelled, completed

  // Recurrence (iCal RRULE format)
  recurrenceRule  String?  // RRULE:FREQ=WEEKLY;BYDAY=MO,WE,FR
  recurrenceEndDate DateTime?
  parentEventId   String?
  parent          CalendarEvent?  @relation("EventOccurrences", fields: [parentEventId], references: [id], onDelete: Cascade)
  occurrences     CalendarEvent[] @relation("EventOccurrences")

  // Color/category
  color           String?
  priority        String   @default("normal") // low, normal, high, urgent

  // Notes
  notes           String?

  // Relations
  horseId         String?
  horse           Horse?   @relation(fields: [horseId], references: [id], onDelete: SetNull)

  riderId         String?
  rider           Rider?   @relation(fields: [riderId], references: [id], onDelete: SetNull)

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById     String
  createdBy       User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  reminders       EventReminder[]

  @@index([organizationId, startDate])
  @@index([horseId, startDate])
  @@index([type, startDate])
  @@index([parentEventId])
  @@map("calendar_events")
}

model EventReminder {
  id              String   @id @default(uuid())

  // Reminder settings
  reminderType    String   @default("push") // email, push, both
  reminderTime    Int      // minutes before event

  // Status
  sent            Boolean  @default(false)
  sentAt          DateTime?
  failedAt        DateTime?
  failureReason   String?

  // Relations
  eventId         String
  event           CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([eventId, userId, reminderTime])
  @@index([sent, eventId])
  @@map("event_reminders")
}

// ==================== HEALTH REMINDERS ====================

model HealthReminder {
  id              String   @id @default(uuid())

  // Reminder type
  type            String   // vaccination_due, deworming_due, vet_checkup_due, dental_due, farrier_due

  // Timing
  dueDate         DateTime
  reminderDate    DateTime // When to send the reminder

  // Status
  status          String   @default("pending") // pending, sent, dismissed, completed
  sentAt          DateTime?

  // Related health record (if applicable)
  healthRecordId  String?
  healthRecord    HealthRecord? @relation(fields: [healthRecordId], references: [id], onDelete: SetNull)

  // Horse
  horseId         String
  horse           Horse    @relation("HorseHealthReminders", fields: [horseId], references: [id], onDelete: Cascade)

  // Organization
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Message
  title           String
  message         String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId, status, reminderDate])
  @@index([horseId, type])
  @@map("health_reminders")
}
